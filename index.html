<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive VIT-AP Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/4285F4/FFFFFF?text=V">
    <style>
        :root {
            --bg-color: #f8f9fa; --text-color: #212529; --text-color-light: #6c757d;
            --card-bg-color: #ffffff; --card-border-color: #e9ecef; --brand-grad-1: #4285F4;
            --brand-grad-2: #9b72cb; --button-bg: rgba(255, 255, 255, 0.7);
            --button-border: rgba(0, 0, 0, 0.1); --button-text: #333; --button-active-bg: #4285F4;
            --button-active-border: #4285F4; --button-active-text: #ffffff; --logo-bg: #f0f4ff;
            --logo-border: #dbe1ff; --logo-text: #4364c6;
        }
        .theme-dark {
            --bg-color: #131314; --text-color: #e0e0e0; --text-color-light: #888;
            --card-bg-color: #1e1f20; --card-border-color: rgba(255, 255, 255, 0.1);
            --brand-grad-1: #89b1ff; --brand-grad-2: #ad99ff; --button-bg: rgba(255, 255, 255, 0.05);
            --button-border: rgba(255, 255, 255, 0.15); --button-text: #e0e0e0;
            --button-active-bg: rgba(137, 177, 255, 0.2); --button-active-border: rgba(137, 177, 255, 0.5);
            --button-active-text: #e0e0e0; --logo-bg: #2a2c33; --logo-border: #3b3d46; --logo-text: #a8bbf0;
        }
        .theme-ocean {
            --bg-color: #f0f9ff; --text-color: #0c4a6e; --text-color-light: #3880a9;
            --card-bg-color: #ffffff; --card-border-color: #e0f2fe; --brand-grad-1: #0ea5e9;
            --brand-grad-2: #14b8a6; --button-active-bg: #0ea5e9; --button-active-border: #0ea5e9;
        }
        .theme-cyberpunk {
            --bg-color: #0d0c1d; --text-color: #c0c0ff; --text-color-light: #8080c0;
            --card-bg-color: rgba(10, 10, 30, 0.6); --card-border-color: #39388a;
            --brand-grad-1: #00f5d4; --brand-grad-2: #ff00ff; --button-bg: rgba(0, 245, 212, 0.05);
            --button-border: rgba(0, 245, 212, 0.2); --button-text: #c0c0ff;
            --button-active-bg: rgba(0, 245, 212, 0.2); --button-active-border: #00f5d4;
            --button-active-text: #ffffff; --logo-bg: rgba(0, 245, 212, 0.1);
            --logo-border: rgba(0, 245, 212, 0.3); --logo-text: #00f5d4;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .theme-cyberpunk body { background-image: linear-gradient(rgba(100, 100, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(100, 100, 255, 0.05) 1px, transparent 1px); background-size: 2rem 2rem; }
        body::after { content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uAgMDAwP7L/lOAAAAF3RSTlMASCD+vwgP3x/Pz9/f39/f39/f39/f3/D0LwL/AAAAx0lEQVR42mP2BxkAAkAAQgwA2cO43IAwmO5gAAnAAODt4gIAz0sUACSAADzTvwvAAKLSxA1wBlwAAsAAdxI+ADwRCQAgAAw8Bf4wAEsA1QIAkAAg8C/O/wCAADAC+wEAAEAASAAB4QAAAeABb/9AAIAABAAkAAWAAAEAAkAAUEAAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAh0y/wEAAEAASAAB4QAAAAeAA3/9AAIAABAAAADn/0gAAAABJRU5ErkJggg==); opacity: 0.04; pointer-events: none; z-index: -1; }
        .brand-gradient-text { background: -webkit-linear-gradient(45deg, var(--brand-grad-1), var(--brand-grad-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-bg { background-color: var(--card-bg-color); border: 1px solid var(--card-border-color); }
        .glass-button { background: var(--button-bg); border: 1px solid var(--button-border); color: var(--button-text); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: all 0.2s ease; }
        .glass-button:hover { border-color: var(--brand-grad-1); }
        .glass-button.active { background: var(--button-active-bg); border-color: var(--button-active-border); color: var(--button-active-text); font-weight: 600; }
        .day-timeline { position: relative; padding-left: 90px; }
        .timeline-line { position: absolute; left: 25px; top: 0; bottom: 0; width: 2px; background: var(--card-border-color); }
        .class-card-timeline { position: absolute; left: 95px; right: 10px; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; border-left-width: 4px; }
        .class-card-timeline:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .time-marker { position: absolute; left: -75px; font-size: 0.75rem; color: var(--text-color-light); font-weight: 500; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .header-controls { position: absolute; top: 1rem; left: 1rem; display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; z-index: 10; }
        .user-controls { position: absolute; top: 1rem; right: 1rem; display: flex; align-items: center; gap: 0.5rem; z-index: 10; }
        .beta-logo { cursor: pointer; display: flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.6rem; background-color: var(--logo-bg); border: 1px solid var(--logo-border); border-radius: 9999px; font-size: 0.875rem; font-weight: 600; color: var(--logo-text); }
        #theme-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none; padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; }
        .tab-btn.active { border-bottom: 2px solid var(--brand-grad-1); color: var(--text-color); }
        .tab-btn { color: var(--text-color-light); }
        #add-class-modal-content input, #add-class-modal-content select { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--card-border-color); }
        #add-class-modal-content label, #add-class-modal-content h3 { color: var(--text-color); }
        @media (max-width: 768px) { .header-controls, .user-controls { position: static; width: 100%; flex-direction: row; justify-content: space-between; margin-bottom: 1rem; } .day-timeline { padding-left: 60px; } .class-card-timeline { left: 65px; } .time-marker { left: -50px; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="auth-container" class="hidden flex items-center justify-center min-h-screen">
        <div class="card-bg p-8 rounded-2xl shadow-lg max-w-md w-full text-center">
            <h1 class="text-3xl font-bold brand-gradient-text">Welcome</h1>
            <p class="text-gray-500 mt-2">Sign in to save and view your personal timetable.</p>
            <button id="google-login-btn" class="mt-8 w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.67-11.283-8.591l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.591 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-error" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>
    
    <div id="app-container" class="hidden max-w-7xl mx-auto relative">
        <div class="header-controls">
            <div id="beta-button" class="beta-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"/></svg>
                <span>Beta</span>
            </div>
            <div class="relative">
                <select id="theme-select" class="glass-button rounded-full py-1 pl-3">
                    <option value="theme-light">Default Light</option>
                    <option value="theme-dark">Midnight Dark</option>
                    <option value="theme-ocean">Ocean Blue</option>
                    <option value="theme-cyberpunk">Cyberpunk Grid</option>
                </select>
            </div>
        </div>
        <header class="mb-8 text-center pt-24 md:pt-0">
            <h1 class="text-4xl md:text-5xl font-bold brand-gradient-text">My VIT-AP Timetable</h1>
            <p class="text-gray-500 mt-2">Your interactive schedule for the semester.</p>
        </header>
        <div class="user-controls">
            <button id="delete-timetable-btn" class="bg-red-500 text-white font-semibold text-sm py-2 px-4 rounded-full hover:bg-red-600 transition">Delete Timetable</button>
            <button id="logout-btn" class="glass-button text-sm font-semibold py-2 px-4 rounded-full">Logout</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-bg p-6 rounded-2xl"><h2 class="font-bold text-lg text-gray-700 mb-2">Next Up</h2><div id="next-class-card" class="text-gray-600">Loading...</div></div>
            <div class="card-bg p-6 rounded-2xl"><h2 class="font-bold text-lg text-gray-700 mb-2">Day's First Class</h2><div id="first-class-card" class="text-gray-600">Loading...</div></div>
            <div class="card-bg p-6 rounded-2xl"><h2 class="font-bold text-lg text-gray-700 mb-2">Day's Last Class</h2><div id="last-class-card" class="text-gray-600">Loading...</div></div>
        </div>
        <div id="day-selector-container" class="card-bg p-4 rounded-2xl mb-8"><div id="day-selector" class="flex flex-wrap justify-center gap-3"></div></div>
        <div id="course-legend" class="card-bg p-4 rounded-2xl mb-8"></div>
        <div id="timetable-container" class="card-bg p-4 rounded-2xl"><div id="day-timeline" class="day-timeline relative"></div></div>
    </div>
    
    <div id="import-container" class="hidden max-w-5xl mx-auto mt-8">
         <div class="card-bg p-6 rounded-2xl">
            <h2 class="text-2xl font-bold text-center brand-gradient-text">Import Your Timetable</h2>
            
            <div id="initial-import-view">
                <div id="import-tabs" class="border-b border-gray-200 mt-4 mb-6 flex justify-center">
                    <button data-tab="api" class="tab-btn active py-2 px-4 font-semibold">Import via API</button>
                    <button data-tab="manual" class="tab-btn py-2 px-4 font-semibold">Manual Builder</button>
                </div>

                <div id="tab-content-api" class="tab-content">
                    <h4 class="font-bold text-center">VTOP API Import</h4>
                    <p class="text-center text-gray-500 mb-4 text-sm">Enter your VTOP credentials to automatically fetch your timetable. Make sure your local API server is running.</p>
                    <form id="api-import-form" class="max-w-sm mx-auto space-y-4">
                        <div>
                            <label for="reg-no-input" class="block text-sm font-medium text-gray-700">Registration Number</label>
                            <input type="text" id="reg-no-input" placeholder="e.g., 21BCE0001" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="password-input" class="block text-sm font-medium text-gray-700">VTOP Password</label>
                            <input type="password" id="password-input" placeholder="••••••••" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="sem-id-input" class="block text-sm font-medium text-gray-700">Semester ID</label>
                            <input type="text" id="sem-id-input" placeholder="e.g., VL20242501" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="api-import-btn" type="submit" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition">Fetch Timetable</button>
                    </form>
                </div>

                <div id="tab-content-manual" class="tab-content hidden">
                    <p class="text-center text-gray-500 mb-4">Use the builder below to manually create your schedule from scratch.</p>
                    <div class="text-center">
                        <button id="launch-builder-btn" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition">Launch Schedule Builder</button>
                    </div>
                </div>

                <div id="loading-container" class="hidden text-center my-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="mt-4 text-gray-600">Fetching data from VTOP via your local API...</p>
                </div>
                <p id="import-error" class="text-red-500 mt-4 text-sm text-center"></p>

            </div>
            
            <div id="review-view" class="hidden">
                 <h3 class="text-xl font-bold text-center text-gray-800">Build Your Schedule</h3>
                 <p class="text-center text-gray-500 mb-6 text-sm">Add your courses first, then build your weekly schedule day by day.</p>
                 
                 <div class="mb-8">
                     <h4 class="font-bold text-lg mb-2">1. Manage Courses</h4>
                     <div class="card-bg p-4 rounded-lg">
                         <div id="course-list-editor" class="mb-4 space-y-2"></div>
                         <div class="flex gap-2">
                             <input id="new-course-name" type="text" placeholder="New Course Name" class="flex-grow p-2 border rounded-md">
                             <input id="new-course-color" type="color" value="#4285F4" class="p-1 h-10 w-10 block bg-white border border-gray-200 cursor-pointer rounded-lg">
                             <button id="add-course-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Add</button>
                         </div>
                     </div>
                 </div>

                 <div>
                     <h4 class="font-bold text-lg mb-2">2. Weekly Schedule</h4>
                     <div class="card-bg p-4 rounded-lg">
                         <div id="schedule-day-tabs" class="border-b border-gray-200 flex"></div>
                         <div id="schedule-day-content" class="mt-4"></div>
                     </div>
                 </div>

                 <div class="flex gap-4 mt-8">
                     <button id="cancel-build-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                     <button id="confirm-save-btn" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition">Save Timetable</button>
                 </div>
            </div>
         </div>
    </div>

    <div id="class-modal" class="modal-backdrop hidden"> <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-md p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="class-modal-content"></div> </div>
    <div id="beta-modal" class="modal-backdrop hidden"> <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-sm p-8 relative transform transition-all duration-300 scale-95 opacity-0 text-center" id="beta-modal-content"><p class="text-xl font-bold brand-gradient-text">Psst!</p><p class="mt-2 text-gray-500">Cats are working in the backend.</p></div> </div>
    <div id="delete-modal" class="modal-backdrop hidden"> <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-sm p-8 relative transform transition-all duration-300 scale-95 opacity-0 text-center" id="delete-modal-content"><h3 class="text-xl font-bold text-gray-800">Are you sure?</h3><p class="mt-2 text-gray-500">This will permanently delete your timetable.</p><div class="mt-6 flex justify-center gap-4"><button id="cancel-delete-btn" class="glass-button font-semibold py-2 px-4 rounded-lg">Cancel</button><button id="confirm-delete-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Yes, Delete</button></div></div> </div>
    <div id="add-class-modal" class="modal-backdrop hidden"> <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-lg p-8 relative" id="add-class-modal-content"></div> </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- START: CONFIGURATION ---
        
        // VTOP API Configuration
        const VTOP_API_URL = 'http://127.0.0.1:8000/student/all_data';
        const VTOP_API_KEY = 'YOUR_API_KEY'; // IMPORTANT: Replace with the key you created in your .env file

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDguREMxNYeUnBysfIyB6cCaGp8k2ZypbY",
            authDomain: "vit-ap-easy-timetable.firebaseapp.com",
            projectId: "vit-ap-easy-timetable",
            storageBucket: "vit-ap-easy-timetable.appspot.com",
            messagingSenderId: "972609523565",
            appId: "1:972609523565:web:91259fb444d72d19979464"
        };
        
        // --- END: CONFIGURATION ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let schedule = []; 
        let userCourses = {};
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MINUTE_TO_PX = 1.5;
        const CARD_GAP = 5;
        const MIN_CARD_HEIGHT = 110;

        // --- Helper Functions ---
        function timeToMinutes(timeStr) {
            if (!timeStr || !/^\d{2}:\d{2}$/.test(timeStr)) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatTime12hr(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const formattedMinutes = String(minutes).padStart(2, '0');
            return `${formattedHours}:${formattedMinutes} ${ampm}`;
        }

        function formatTimeStr12hr(timeStr) {
            if (!timeStr || !/^\d{2}:\d{2}$/.test(timeStr)) return "Invalid Time";
            const [hours, minutes] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(hours, minutes);
            return formatTime12hr(d);
        }

        // --- Main Display Logic (No changes needed here) ---
        function displayDay(selectedDay) {
            const timeline = document.getElementById('day-timeline');
            if (!timeline) return;
            
            const totalHours = (21 - 8);
            timeline.style.height = `${totalHours * 60 * MINUTE_TO_PX}px`;
            timeline.innerHTML = '<div class="timeline-line"></div>';

            const classesForDay = schedule.filter(c => c.day === selectedDay).sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

            const timeMarkers = new Set();
            for (let i = 8; i <= 20; i++) { timeMarkers.add(`${i}:00`); }
            classesForDay.forEach(cls => {
                if (cls.startTime && /^\d{2}:\d{2}$/.test(cls.startTime) && cls.startTime.split(':')[1] !== '00') {
                    timeMarkers.add(cls.startTime);
                }
            });

            timeMarkers.forEach(timeStr => {
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.textContent = formatTimeStr12hr(timeStr);
                const position = (timeToMinutes(timeStr) - 8 * 60) * MINUTE_TO_PX;
                marker.style.top = `${position}px`;
                timeline.appendChild(marker);
            });

            let lastCardBottom = -1;
            classesForDay.forEach((cls) => {
                const startMinutes = timeToMinutes(cls.startTime);
                const endMinutes = timeToMinutes(cls.endTime);
                if (isNaN(startMinutes) || isNaN(endMinutes) || startMinutes >= endMinutes) return;

                let top = (startMinutes - 8 * 60) * MINUTE_TO_PX;
                if (top < lastCardBottom) { top = lastCardBottom; }
                let height = (endMinutes - startMinutes) * MINUTE_TO_PX;
                if (height < MIN_CARD_HEIGHT) { height = MIN_CARD_HEIGHT; }

                const card = document.createElement('div');
                const colorInfo = userCourses[cls.courseName] || { bg: 'rgba(107, 114, 128, 0.1)', border: '#6B7280', text: '#4B5563' };
                card.className = 'class-card-timeline';
                card.style.top = `${top}px`;
                card.style.height = `${height - CARD_GAP}px`;
                card.style.backgroundColor = colorInfo.bg;
                card.style.borderColor = colorInfo.border;
                card.dataset.classIndex = schedule.indexOf(cls);
                card.innerHTML = `<div class="flex flex-col h-full justify-center"><p class="font-bold text-gray-800">${cls.courseName || 'N/A'} (${cls.type || 'N/A'})</p><p class="text-sm text-gray-600 mt-1">${cls.instructor || 'N/A'}</p><p class="text-xs text-gray-500 mt-2">${cls.location || 'N/A'}</p><p class="text-xs font-semibold mt-2" style="color:${colorInfo.border};">${formatTimeStr12hr(cls.startTime)} - ${formatTimeStr12hr(cls.endTime)}</p></div>`;
                card.addEventListener('click', () => showClassModal(schedule.indexOf(cls)));
                timeline.appendChild(card);
                lastCardBottom = top + height;
            });
        }
        
        // ... Other UI functions like showClassModal, updateInfoCards, etc. remain the same ...
        // [NOTE: For brevity, the unchanged helper and UI functions are omitted here but are present in your original file and should be kept]

        // --- NEW: API Import Logic ---
        function processApiResponseData(apiData) {
            // This function transforms the data from your API into the format the frontend needs.
            // It assumes apiData has a "timetable" property which is an array of class objects.
            if (!apiData || !apiData.timetable || !Array.isArray(apiData.timetable)) {
                console.error("Invalid data structure from API:", apiData);
                throw new Error("Received invalid or empty data structure from the API.");
            }
            
            // The API data structure is already very close to what's needed.
            // We just need to ensure all required fields are present.
            return apiData.timetable.map(cls => ({
                courseName: cls.courseName || "Unnamed Course",
                type: cls.type || "N/A",
                instructor: cls.instructor || "N/A",
                day: cls.day || "Mon",
                startTime: cls.startTime || "00:00",
                endTime: cls.endTime || "00:00",
                location: cls.location || "N/A"
            }));
        }

        async function importFromVtopApi() {
            const loadingContainer = document.getElementById('loading-container');
            const importError = document.getElementById('import-error');
            
            const regNo = document.getElementById('reg-no-input').value;
            const password = document.getElementById('password-input').value;
            const semId = document.getElementById('sem-id-input').value;

            if (!regNo || !password || !semId) {
                importError.textContent = "Please fill in all fields.";
                return;
            }

            if (VTOP_API_KEY === 'YOUR_API_KEY') {
                importError.textContent = "Error: Please set your VTOP_API_KEY in the script configuration section.";
                return;
            }

            loadingContainer.classList.remove('hidden');
            importError.textContent = "";

            try {
                const payload = {
                    "registration_number": regNo,
                    "password": password,
                    "sem_sub_id": semId
                };

                const response = await fetch(VTOP_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': VTOP_API_KEY
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API server returned an error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const processedData = processApiResponseData(data);
                
                if (processedData.length === 0) {
                    throw new Error("API returned no classes. Please check your credentials and Semester ID.");
                }
                
                showBuilderScreen(processedData);

            } catch (error) {
                console.error("API import failed:", error);
                importError.textContent = `Import failed. ${error.message}. Is your local API server running?`;
            } finally {
                loadingContainer.classList.add('hidden');
            }
        }

        // --- DOMContentLoaded: Main entry point ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (All your existing element getters)

            const apiImportBtn = document.getElementById('api-import-btn');
            const apiImportForm = document.getElementById('api-import-form');
            const importTabs = document.getElementById('import-tabs');
            const launchBuilderBtn = document.getElementById('launch-builder-btn');
            
            // --- Set up auth listener ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    listenToTimetable(user.uid);
                } else {
                    if (unsubscribe) unsubscribe();
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('import-container').classList.add('hidden');
                    stopAppIntervals();
                }
            });

            // --- Add all other event listeners ---
            setupThemeSwitcher();
            
            // New listener for the API import button
            apiImportForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent form from reloading the page
                importFromVtopApi();
            });

            // Listener for import tabs
            importTabs.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') return;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
            });
            
            launchBuilderBtn.addEventListener('click', () => {
                showBuilderScreen([]);
            });
            
            // ... (All your other event listeners for builder, modals, etc. remain the same)
            // [NOTE: For brevity, these listeners are omitted but should be kept from your original file]
        });

        // Placeholder for functions that were omitted for brevity but should be kept
        // Make sure you have these functions from your original code:
        // - listenToTimetable, initializeAppView, startAppIntervals, stopAppIntervals
        // - updateInfoCards, renderCourseLegend, setupDaySelector, setupThemeSwitcher
        // - All modal functions (show/close ClassModal, BetaModal, DeleteModal, AddClassModal)
        // - All builder functions (showBuilderScreen, renderCourseEditor, renderDayTabs, renderDayContent)
        // - All builder event listeners (confirmSaveBtn, cancelBuildBtn, addCourseBtn, etc.)
    </script>
</body>
</html>
