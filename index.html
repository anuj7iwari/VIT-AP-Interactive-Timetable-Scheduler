<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive VIT-AP Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/4285F4/FFFFFF?text=V">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --text-color-light: #6c757d;
            --card-bg-color: #ffffff;
            --card-border-color: #e9ecef;
            --brand-grad-1: #4285F4;
            --brand-grad-2: #9b72cb;
            --button-bg: rgba(255, 255, 255, 0.7);
            --button-border: rgba(0, 0, 0, 0.1);
            --button-text: #333;
            --button-active-bg: #4285F4;
            --button-active-border: #4285F4;
            --button-active-text: #ffffff;
            --logo-bg: #f0f4ff;
            --logo-border: #dbe1ff;
            --logo-text: #4364c6;
        }

        .theme-dark {
            --bg-color: #131314;
            --text-color: #e0e0e0;
            --text-color-light: #888;
            --card-bg-color: #1e1f20;
            --card-border-color: rgba(255, 255, 255, 0.1);
            --brand-grad-1: #89b1ff;
            --brand-grad-2: #ad99ff;
            --button-bg: rgba(255, 255, 255, 0.05);
            --button-border: rgba(255, 255, 255, 0.15);
            --button-text: #e0e0e0;
            --button-active-bg: rgba(137, 177, 255, 0.2);
            --button-active-border: rgba(137, 177, 255, 0.5);
            --button-active-text: #e0e0e0;
            --logo-bg: #2a2c33;
            --logo-border: #3b3d46;
            --logo-text: #a8bbf0;
        }

        .theme-ocean {
            --bg-color: #f0f9ff;
            --text-color: #0c4a6e;
            --text-color-light: #3880a9;
            --card-bg-color: #ffffff;
            --card-border-color: #e0f2fe;
            --brand-grad-1: #0ea5e9;
            --brand-grad-2: #14b8a6;
            --button-active-bg: #0ea5e9;
            --button-active-border: #0ea5e9;
        }

        .theme-cyberpunk {
            --bg-color: #0d0c1d;
            --text-color: #c0c0ff;
            --text-color-light: #8080c0;
            --card-bg-color: rgba(10, 10, 30, 0.6);
            --card-border-color: #39388a;
            --brand-grad-1: #00f5d4;
            --brand-grad-2: #ff00ff;
            --button-bg: rgba(0, 245, 212, 0.05);
            --button-border: rgba(0, 245, 212, 0.2);
            --button-text: #c0c0ff;
            --button-active-bg: rgba(0, 245, 212, 0.2);
            --button-active-border: #00f5d4;
            --button-active-text: #ffffff;
            --logo-bg: rgba(0, 245, 212, 0.1);
            --logo-border: rgba(0, 245, 212, 0.3);
            --logo-text: #00f5d4;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .theme-cyberpunk body {
            background-image:
                linear-gradient(rgba(100, 100, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(100, 100, 255, 0.05) 1px, transparent 1px);
            background-size: 2rem 2rem;
        }

        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N3d3dtbW17e3t1dXWBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uBgYGHh4d5eXlzc3OLi4ubm5uVlZWYmJitbW1oaGhra2uAgMDAwP7L/lOAAAAF3RSTlMASCD+vwgP3x/Pz9/f39/f39/f39/f3/D0LwL/AAAAx0lEQVR42mP2BxkAAkAAQgwA2cO43IAwmO5gAAnAAODt4gIAz0sUACSAADzTvwvAAKLSxA1wBlwAAsAAdxI+ADwRCQAgAAw8Bf4wAEsA1QIAkAAg8C/O/wCAADAC+wEAAEAASAAB4QAAAeABb/9AAIAABAAkAAWAAAEAAkAAUEAAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAUEAAh0y/wEAAEAASAAB4QAAAAeAA3/9AAIAABAAAADn/0gAAAABJRU5ErkJggg==);
            opacity: 0.04;
            pointer-events: none;
            z-index: -1;
        }

        .brand-gradient-text {
            background: -webkit-linear-gradient(45deg, var(--brand-grad-1), var(--brand-grad-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-bg {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
        }
        .glass-button {
            background: var(--button-bg);
            border: 1px solid var(--button-border);
            color: var(--button-text);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        .glass-button:hover {
            border-color: var(--brand-grad-1);
        }
        .glass-button.active {
            background: var(--button-active-bg);
            border-color: var(--button-active-border);
            color: var(--button-active-text);
            font-weight: 600;
        }
        .day-timeline { position: relative; padding-left: 90px; }
        .timeline-line { position: absolute; left: 25px; top: 0; bottom: 0; width: 2px; background: var(--card-border-color); }
        .class-card-timeline { position: absolute; left: 95px; right: 10px; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; border-left-width: 4px; }
        .class-card-timeline:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .time-marker { position: absolute; left: -75px; font-size: 0.75rem; color: var(--text-color-light); font-weight: 500; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 50; }

        .header-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            z-index: 10;
        }
        .cat-clock {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .user-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
        }

        .beta-logo { cursor: pointer; display: flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.6rem; background-color: var(--logo-bg); border: 1px solid var(--logo-border); border-radius: 9999px; font-size: 0.875rem; font-weight: 600; color: var(--logo-text); }
        #theme-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none; padding-right: 1.5rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; }

        .tab-btn.active {
            border-bottom: 2px solid var(--brand-grad-1);
            color: var(--text-color);
        }
        .tab-btn {
            color: var(--text-color-light);
        }

        /* Fix for modal inputs */
        #add-class-modal-content input, #add-class-modal-content select {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--card-border-color);
        }
        #add-class-modal-content label, #add-class-modal-content h3 {
             color: var(--text-color);
        }


        @media (max-width: 768px) {
            .header-controls, .user-controls {
                position: static;
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                margin-bottom: 1rem;
            }
            .cat-clock {
                position: static;
                margin-top: -1.5rem;
                margin-bottom: 1rem;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
             .day-timeline { padding-left: 60px; }
             .class-card-timeline { left: 65px; }
             .time-marker { left: -50px; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Auth Container -->
    <div id="auth-container" class="hidden flex items-center justify-center min-h-screen">
        <div class="card-bg p-8 rounded-2xl shadow-lg max-w-md w-full text-center">
            <h1 class="text-3xl font-bold brand-gradient-text">Welcome</h1>
            <p class="text-gray-500 mt-2">Sign in to save and view your personal timetable.</p>
            <button id="google-login-btn" class="mt-8 w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition flex items-center justify-center gap-2">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.67-11.283-8.591l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.021 35.591 44 30.138 44 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
                Sign in with Google
            </button>
            <p id="auth-error" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>
    
    <!-- App Container -->
    <div id="app-container" class="hidden max-w-7xl mx-auto relative">
        <div class="header-controls">
            <div id="beta-button" class="beta-logo">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"/></svg>
                <span>Beta</span>
            </div>
            <div class="relative">
                <select id="theme-select" class="glass-button rounded-full py-1 pl-3">
                    <option value="theme-light">Default Light</option>
                    <option value="theme-dark">Midnight Dark</option>
                    <option value="theme-ocean">Ocean Blue</option>
                    <option value="theme-cyberpunk">Cyberpunk Grid</option>
                </select>
            </div>
        </div>

        <header class="mb-8 text-center pt-24 md:pt-0">
            <h1 class="text-4xl md:text-5xl font-bold brand-gradient-text">My VIT-AP Timetable</h1>
            <p class="text-gray-500 mt-2">Your interactive schedule for the semester.</p>
        </header>

        <div id="cat-clock" class="cat-clock">
            <span id="clock-text">--:-- --</span>
        </div>

        <div class="user-controls">
            <button id="delete-timetable-btn" class="bg-red-500 text-white font-semibold text-sm py-2 px-4 rounded-full hover:bg-red-600 transition">Delete Timetable</button>
            <button id="logout-btn" class="glass-button text-sm font-semibold py-2 px-4 rounded-full">Logout</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-bg p-6 rounded-2xl">
                <h2 class="font-bold text-lg text-gray-700 mb-2">Next Up</h2>
                <div id="next-class-card" class="text-gray-600">Loading...</div>
            </div>
            <div class="card-bg p-6 rounded-2xl">
                <h2 class="font-bold text-lg text-gray-700 mb-2">Day's First Class</h2>
                <div id="first-class-card" class="text-gray-600">Loading...</div>
            </div>
            <div class="card-bg p-6 rounded-2xl">
                <h2 class="font-bold text-lg text-gray-700 mb-2">Day's Last Class</h2>
                <div id="last-class-card" class="text-gray-600">Loading...</div>
            </div>
        </div>
        
        <div id="day-selector-container" class="card-bg p-4 rounded-2xl mb-8">
            <div id="day-selector" class="flex flex-wrap justify-center gap-3"></div>
        </div>

        <div id="course-legend" class="card-bg p-4 rounded-2xl mb-8"></div>

        <div id="timetable-container" class="card-bg p-4 rounded-2xl">
            <div id="day-timeline" class="day-timeline relative"></div>
        </div>
    </div>
    
    <!-- Import Container -->
    <div id="import-container" class="hidden max-w-5xl mx-auto mt-8">
         <div class="card-bg p-6 rounded-2xl">
            <h2 class="text-2xl font-bold text-center brand-gradient-text">Import Your Timetable</h2>
            
            <div id="initial-import-view">
                <div id="import-tabs" class="border-b border-gray-200 mt-4 mb-6 flex justify-center">
                    <button data-tab="easy" class="tab-btn active py-2 px-4 font-semibold">Easy Import (AI)</button>
                    <button data-tab="manual" class="tab-btn py-2 px-4 font-semibold">Manual Builder</button>
                </div>

                <!-- Easy Import Tab -->
                <div id="tab-content-easy" class="tab-content prose max-w-none">
                     <h4 class="font-bold">AI-Powered Timetable Import</h4>
                    <p>Our new AI-powered importer can read almost any VTOP timetable page. No more errors!</p>
                    <ol>
                        <li><strong>Drag this link to your bookmarks bar:</strong>
                            <a id="bookmarklet-link" href="#" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg inline-block">Scrape VTOP with AI</a>
                        </li>
                        <li>Log in to VTOP and navigate to your weekly timetable page OR your registered courses list.</li>
                        <li>Click the "Scrape VTOP with AI" bookmark.</li>
                    </ol>
                    <p>The AI will analyze the page and you'll be redirected here to review and save your schedule.</p>
                </div>

                <!-- Manual Builder Tab -->
                <div id="tab-content-manual" class="tab-content hidden">
                    <p class="text-center text-gray-500 mb-4">Use the builder below to manually create your schedule from scratch.</p>
                     <div class="text-center">
                        <button id="launch-builder-btn" class="bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition">Launch Schedule Builder</button>
                    </div>
                </div>

                <div id="loading-container" class="hidden text-center my-6">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="mt-4 text-gray-600 dark:text-gray-300">AI is analyzing your timetable... This may take a moment.</p>
                </div>
                <p id="import-error" class="text-red-500 mt-4 text-sm text-center"></p>

            </div>
            
            <!-- Review / Builder View -->
            <div id="review-view" class="hidden">
                 <h3 class="text-xl font-bold text-center text-gray-800">Build Your Schedule</h3>
                 <p class="text-center text-gray-500 mb-6 text-sm">Add your courses first, then build your weekly schedule day by day.</p>
                
                 <!-- Course Manager -->
                 <div class="mb-8">
                    <h4 class="font-bold text-lg mb-2">1. Manage Courses</h4>
                    <div class="card-bg p-4 rounded-lg">
                        <div id="course-list-editor" class="mb-4 space-y-2"></div>
                        <div class="flex gap-2">
                            <input id="new-course-name" type="text" placeholder="New Course Name" class="flex-grow p-2 border rounded-md">
                            <input id="new-course-color" type="color" value="#4285F4" class="p-1 h-10 w-10 block bg-white border border-gray-200 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                            <button id="add-course-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Add</button>
                        </div>
                    </div>
                 </div>

                 <!-- Schedule Builder -->
                 <div>
                    <h4 class="font-bold text-lg mb-2">2. Weekly Schedule</h4>
                    <div class="card-bg p-4 rounded-lg">
                        <div id="schedule-day-tabs" class="border-b border-gray-200 flex"></div>
                        <div id="schedule-day-content" class="mt-4"></div>
                    </div>
                 </div>

                 <div class="flex gap-4 mt-8">
                    <button id="cancel-build-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button id="confirm-save-btn" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition">Save Timetable</button>
                 </div>
            </div>
         </div>
    </div>


    <!-- Creator Footer -->
    <footer class="text-center mt-12 text-gray-500 text-sm">
        <p>Created by Anuj Tiwari</p>
        <div class="flex justify-center gap-4 mt-2">
            <a href="https://github.com/anuj7iwari" target="_blank" class="hover:text-blue-500 transition">GitHub</a>
            <span>&bull;</span>
            <a href="mailto:anuj7iwari@gmail.com" class="hover:text-blue-500 transition">Mail</a>
        </div>
    </footer>

    <!-- Modals -->
    <div id="class-modal" class="modal-backdrop hidden">
        <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-md p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="class-modal-content"></div>
    </div>
    <div id="beta-modal" class="modal-backdrop hidden">
        <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-sm p-8 relative transform transition-all duration-300 scale-95 opacity-0 text-center" id="beta-modal-content">
            <p class="text-xl font-bold brand-gradient-text">Psst!</p>
            <p class="mt-2 text-gray-500">Cats are working in the backend, do not disturb them.</p>
        </div>
    </div>
    <div id="delete-modal" class="modal-backdrop hidden">
        <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-sm p-8 relative transform transition-all duration-300 scale-95 opacity-0 text-center" id="delete-modal-content">
            <h3 class="text-xl font-bold text-gray-800">Are you sure?</h3>
            <p class="mt-2 text-gray-500">This will permanently delete your timetable. This action cannot be undone.</p>
            <div class="mt-6 flex justify-center gap-4">
                <button id="cancel-delete-btn" class="glass-button font-semibold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Yes, Delete It</button>
            </div>
        </div>
    </div>
    <div id="add-class-modal" class="modal-backdrop hidden">
        <div class="card-bg rounded-2xl shadow-2xl w-11/12 max-w-lg p-8 relative transform transition-all duration-300 scale-95 opacity-0" id="add-class-modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add/Edit Class</h3>
            <div class="space-y-4">
                <div>
                    <label class="font-semibold text-gray-700">Course</label>
                    <select id="class-course-select" class="w-full p-2 border rounded-md mt-1"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="font-semibold text-gray-700">Start Time (HH:MM)</label>
                        <input id="class-start-time" type="text" placeholder="e.g., 14:00" class="w-full p-2 border rounded-md mt-1">
                    </div>
                    <div>
                        <label class="font-semibold text-gray-700">End Time (HH:MM)</label>
                        <input id="class-end-time" type="text" placeholder="e.g., 14:50" class="w-full p-2 border rounded-md mt-1">
                    </div>
                </div>
                <div>
                    <label class="font-semibold text-gray-700">Instructor</label>
                    <input id="class-instructor" type="text" class="w-full p-2 border rounded-md mt-1">
                </div>
                <div>
                    <label class="font-semibold text-gray-700">Location</label>
                    <input id="class-location" type="text" class="w-full p-2 border rounded-md mt-1">
                </div>
                 <div>
                    <label class="font-semibold text-gray-700">Type</label>
                    <select id="class-type-select" class="w-full p-2 border rounded-md mt-1">
                        <option>Theory</option>
                        <option>Lab</option>
                    </select>
                </div>
            </div>
            <p id="add-class-error" class="text-red-500 text-sm mt-4 text-center"></p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-add-class-btn" class="glass-button font-semibold py-2 px-4 rounded-lg">Cancel</button>
                <button id="save-class-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Save Class</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            onSnapshot,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- START: CONFIGURATION ---
        
        // IMPORTANT: Add your new, unrestricted Gemini API Key here
  const geminiApiKey = "AIzaSyAn-E9PmEz7aNJXRwa2ynXAZ1Rfad528Ww";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDguREMxNYeUnBysfIyB6cCaGp8k2ZypbY",
  authDomain: "vit-ap-easy-timetable.firebaseapp.com",
  projectId: "vit-ap-easy-timetable",
  storageBucket: "vit-ap-easy-timetable.firebasestorage.app",
  messagingSenderId: "972609523565",
  appId: "1:972609523565:web:91259fb444d72d19979464",
  measurementId: "G-H24YMP7MRT"
};



        // --- END: CONFIGURATION ---


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        let schedule = []; 
        let userCourses = {};

        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const MINUTE_TO_PX = 1.5;
        const CARD_GAP = 5;
        const MIN_CARD_HEIGHT = 110;

        // --- Helper Functions ---
        function timeToMinutes(timeStr) {
            if (!timeStr || !/^\d{2}:\d{2}$/.test(timeStr)) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatTime12hr(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            const formattedMinutes = String(minutes).padStart(2, '0');
            return `${formattedHours}:${formattedMinutes} ${ampm}`;
        }

        function formatTimeStr12hr(timeStr) {
            if (!timeStr || !/^\d{2}:\d{2}$/.test(timeStr)) return "Invalid Time";
            const [hours, minutes] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(hours, minutes);
            return formatTime12hr(d);
        }

        function getTimeOfDay(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return "";
            const [hours] = timeStr.split(':').map(Number);
            if (hours < 12) return 'Morning';
            if (hours < 17) return 'Afternoon';
            return 'Evening';
        }

        // --- Main Display Logic ---
        function displayDay(selectedDay) {
            const timeline = document.getElementById('day-timeline');
            if (!timeline) return;
            
            const totalHours = (21 - 8);
            timeline.style.height = `${totalHours * 60 * MINUTE_TO_PX}px`;
            timeline.innerHTML = '<div class="timeline-line"></div>';

            const classesForDay = schedule
                .filter(c => c.day === selectedDay)
                .sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

            const timeMarkers = new Set();
            for (let i = 8; i <= 20; i++) { timeMarkers.add(`${i}:00`); }
            classesForDay.forEach(cls => {
                if (cls.startTime && /^\d{2}:\d{2}$/.test(cls.startTime) && cls.startTime.split(':')[1] !== '00') {
                    timeMarkers.add(cls.startTime);
                }
            });

            timeMarkers.forEach(timeStr => {
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.textContent = formatTimeStr12hr(timeStr);
                const position = (timeToMinutes(timeStr) - 8 * 60) * MINUTE_TO_PX;
                marker.style.top = `${position}px`;
                timeline.appendChild(marker);
            });

            let lastCardBottom = -1;

            classesForDay.forEach((cls) => {
                const startMinutes = timeToMinutes(cls.startTime);
                const endMinutes = timeToMinutes(cls.endTime);

                if (isNaN(startMinutes) || isNaN(endMinutes) || startMinutes >= endMinutes) return;

                let top = (startMinutes - 8 * 60) * MINUTE_TO_PX;
                if (top < lastCardBottom) {
                    top = lastCardBottom;
                }

                let height = (endMinutes - startMinutes) * MINUTE_TO_PX;
                if (height < MIN_CARD_HEIGHT) {
                    height = MIN_CARD_HEIGHT;
                }

                const card = document.createElement('div');
                const colorInfo = userCourses[cls.courseName] || { bg: 'rgba(107, 114, 128, 0.1)', border: '#6B7280', text: '#4B5563' };
                card.className = 'class-card-timeline';
                card.style.top = `${top}px`;
                card.style.height = `${height - CARD_GAP}px`;
                card.style.backgroundColor = colorInfo.bg;
                card.style.borderColor = colorInfo.border;
                card.dataset.classIndex = schedule.indexOf(cls);
                card.innerHTML = `
                    <div class="flex flex-col h-full justify-center">
                        <p class="font-bold text-gray-800">${cls.courseName || 'N/A'} (${cls.type || 'N/A'})</p>
                        <p class="text-sm text-gray-600 mt-1">${cls.instructor || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-2">${cls.location || 'N/A'}</p>
                        <p class="text-xs font-semibold mt-2" style="color:${colorInfo.border};">${formatTimeStr12hr(cls.startTime)} - ${formatTimeStr12hr(cls.endTime)}</p>
                    </div>
                `;
                card.addEventListener('click', () => showClassModal(schedule.indexOf(cls)));
                timeline.appendChild(card);
                lastCardBottom = top + height;
            });
        }

        function showClassModal(index) {
            const cls = schedule[index];
            const colorInfo = userCourses[cls.courseName] || { bg: 'rgba(107, 114, 128, 0.1)', border: '#6B7280' };
            const classModalContent = document.getElementById('class-modal-content');
            classModalContent.innerHTML = `
                <button id="close-class-modal-btn" class="absolute top-4 right-6 text-3xl font-bold text-gray-400 hover:text-gray-800 transition">&times;</button>
                <div class="p-2">
                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full" style="background-color:${colorInfo.bg}; color:${colorInfo.border}; border: 1px solid ${colorInfo.border};">
                        ${cls.type}
                    </span>
                    <h2 class="text-3xl font-bold text-gray-800 mt-3">${cls.courseName}</h2>
                    <p class="text-md text-gray-500 mb-6">${cls.subjectCode || ''}</p>
                    <div class="space-y-4 text-gray-700">
                        <p><strong>Instructor:</strong> ${cls.instructor}</p>
                        <p><strong>Time:</strong> ${formatTimeStr12hr(cls.startTime)} - ${formatTimeStr12hr(cls.endTime)}</p>
                        <p><strong>Location:</strong> ${cls.location}</p>
                    </div>
                </div>
            `;
            document.getElementById('class-modal').classList.remove('hidden');
            setTimeout(() => { classModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            // Add event listener to the new close button
            document.getElementById('close-class-modal-btn').addEventListener('click', closeClassModal);
        }

        function closeClassModal() {
            const classModalContent = document.getElementById('class-modal-content');
            classModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { document.getElementById('class-modal').classList.add('hidden'); }, 200);
        }
        
        function showBetaModal() {
            document.getElementById('beta-modal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('beta-modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
        }
        function closeBetaModal() {
            document.getElementById('beta-modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { document.getElementById('beta-modal').classList.add('hidden'); }, 200);
        }

        function showDeleteModal() {
            document.getElementById('delete-modal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('delete-modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { document.getElementById('delete-modal').classList.add('hidden'); }, 200);
        }

        const catPhrases = [ "VIT AP is lead by cats", "Cats are coming to destroy VIT AP", "May your class get canceled due to a sudden cat attack", "Porsche manufactures high-end cats", "A cat will eat you if you don't star this project", "Cats will reach Mars before humans", "No more funny catty things... just kidding", "This was made by my cats", "VIT AP lacks cats, held a protest", "VIT AP needs more cats", "cat cat cat fat cat cat cat", "Modi ji is also secretly a cat" ];

        function updateClock() {
            const now = new Date();
            const clockText = document.getElementById('clock-text');
            if (clockText && !clockText.dataset.isPhrase) {
                clockText.textContent = formatTime12hr(now);
            }
        }

        function showCatPhrase() {
            const now = new Date();
            const originalTime = formatTime12hr(now);
            const phrase = catPhrases[Math.floor(Math.random() * catPhrases.length)];
            const clockText = document.getElementById('clock-text');
            if(clockText) {
                clockText.textContent = phrase;
                clockText.dataset.isPhrase = "true";

                setTimeout(() => {
                    if (clockText.textContent === phrase) {
                        clockText.textContent = originalTime;
                        delete clockText.dataset.isPhrase;
                    }
                }, 10000);
            }
        }

        // --- Info Cards Logic ---
        function updateInfoCards() {
            const now = new Date();
            const firstClassCard = document.getElementById('first-class-card');
            const lastClassCard = document.getElementById('last-class-card');
            const nextClassCard = document.getElementById('next-class-card');

            if (!firstClassCard || !lastClassCard || !nextClassCard) return;

            const selectedDayButton = document.querySelector('.glass-button.active');
            if (!selectedDayButton) {
                const placeholder = `<p class="text-lg font-semibold text-gray-500">Select a day to view info.</p>`
                firstClassCard.innerHTML = placeholder;
                lastClassCard.innerHTML = placeholder;
                nextClassCard.innerHTML = placeholder;
                return;
            };
            const selectedDay = selectedDayButton.textContent;
            
            const dayClasses = schedule.filter(c => c.day === selectedDay).sort((a,b) => (a.startTime || "").localeCompare(b.startTime || ""));
            if (dayClasses.length > 0) {
                const first = dayClasses[0];
                const last = dayClasses[dayClasses.length - 1];
                firstClassCard.innerHTML = `<p class="font-semibold text-gray-800">${first.courseName}</p><p><span class="font-semibold text-gray-500">${getTimeOfDay(first.startTime)}</span> at ${formatTimeStr12hr(first.startTime)}</p>`;
                lastClassCard.innerHTML = `<p class="font-semibold text-gray-800">${last.courseName}</p><p><span class="font-semibold text-gray-500">${getTimeOfDay(last.startTime)}</span> at ${formatTimeStr12hr(last.startTime)}</p>`;
            } else {
                const message = `<p class="text-lg font-semibold text-green-600">No classes scheduled.</p>`;
                firstClassCard.innerHTML = message;
                lastClassCard.innerHTML = message;
            }

            const currentDayIndex = now.getDay() - 1;
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            let foundNext = false;

            if (currentDayIndex >= 0 && currentDayIndex < days.length) {
                const runningClass = schedule.find(c => c.day === days[currentDayIndex] && currentTimeInMinutes >= timeToMinutes(c.startTime) && currentTimeInMinutes < timeToMinutes(c.endTime));
                if (runningClass) {
                    nextClassCard.innerHTML = `<p class="font-semibold text-yellow-600 text-lg">In Session</p><p class="font-semibold text-gray-800">${runningClass.courseName}</p><p>Ends at ${formatTimeStr12hr(runningClass.endTime)}</p>`;
                    foundNext = true;
                }
                if (!foundNext) {
                    const nextClassToday = schedule.filter(c => c.day === days[currentDayIndex] && timeToMinutes(c.startTime) > currentTimeInMinutes).sort((a,b)=>a.startTime.localeCompare(b.startTime))[0];
                    if (nextClassToday) {
                        nextClassCard.innerHTML = `<p class="font-semibold text-blue-600 text-lg">${nextClassToday.courseName}</p><p><strong>Today at ${formatTimeStr12hr(nextClassToday.startTime)}</strong></p><p class="text-sm">${nextClassToday.location}</p>`;
                        foundNext = true;
                    }
                }
            }

            if (!foundNext) {
                for (let i = 1; i <= 7; i++) {
                    const nextDayIndex = (currentDayIndex + i) % 7;
                    const nextDayStr = days[nextDayIndex];
                    if(nextDayStr){
                        const nextClass = schedule.filter(c => c.day === nextDayStr).sort((a,b)=>a.startTime.localeCompare(b.startTime))[0];
                        if (nextClass) {
                            nextClassCard.innerHTML = `<p class="font-semibold text-blue-600 text-lg">${nextClass.courseName}</p><p><strong>${nextClass.day} at ${formatTimeStr12hr(nextClass.startTime)}</strong></p><p class="text-sm">${nextClass.location}</p>`;
                            foundNext = true;
                            break;
                        }
                    }
                }
            }
             
             if (!foundNext && schedule.length > 0) {
                 nextClassCard.innerHTML = `<p class="text-lg font-semibold text-green-600">All classes are finished for the week!</p>`;
             } else if (!foundNext && schedule.length === 0) {
                 nextClassCard.innerHTML = `<p class="text-lg font-semibold text-green-600">No classes scheduled.</p>`;
             }
        }

        function renderCourseLegend() {
            const legendContainer = document.getElementById('course-legend');
            let legendHTML = '<h3 class="font-bold text-center mb-3 text-gray-700">Course Legend</h3><div class="flex flex-wrap justify-center gap-x-6 gap-y-2">';
            for (const courseName in userCourses) {
                const colorInfo = userCourses[courseName];
                legendHTML += `
                    <div class="flex items-center gap-2">
                        <span class="w-4 h-4 rounded-full" style="background-color: ${colorInfo.border};"></span>
                        <span class="text-sm text-gray-600">${courseName}</span>
                    </div>
                `;
            }
            legendHTML += '</div>';
            legendContainer.innerHTML = legendHTML;
        }

        function setupDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = '';
            days.forEach(day => {
                const button = document.createElement('button');
                button.className = 'glass-button px-4 py-2 rounded-full font-semibold';
                button.textContent = day;
                button.onclick = () => {
                    document.querySelectorAll('#day-selector button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    displayDay(day);
                    updateInfoCards();
                };
                container.appendChild(button);
            });
        }

        function setupThemeSwitcher() {
            const themeSelect = document.getElementById('theme-select');
            const savedTheme = localStorage.getItem('timetableTheme') || 'theme-light';
            
            document.documentElement.className = savedTheme;
            themeSelect.value = savedTheme;

            themeSelect.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                document.documentElement.className = newTheme;
                localStorage.setItem('timetableTheme', newTheme);
            });
        }

        let unsubscribe;

        function listenToTimetable(userId) {
            if (unsubscribe) unsubscribe();
            
            const timetableRef = doc(db, "timetables", userId);
            unsubscribe = onSnapshot(timetableRef, (doc) => {
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');
                const importContainer = document.getElementById('import-container');

                if (doc.exists() && doc.data().schedule && doc.data().schedule.length > 0) {
                    schedule = doc.data().schedule;
                    userCourses = doc.data().courses || {};
                    importContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    authContainer.classList.add('hidden');
                    initializeAppView();
                    startAppIntervals();
                } else {
                    schedule = [];
                    userCourses = {};
                    importContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    authContainer.classList.add('hidden');
                    stopAppIntervals();
                    // If no timetable, make sure the bookmarklet link is ready.
                    setupBookmarkletLink();
                }
            });
        }

        // --- App Initialization ---
        let clockInterval, phraseInterval, infoInterval;

        function startAppIntervals() {
            if (clockInterval) clearInterval(clockInterval);
            if (phraseInterval) clearInterval(phraseInterval);
            if (infoInterval) clearInterval(infoInterval);

            updateClock();
            clockInterval = setInterval(updateClock, 1000);
            phraseInterval = setInterval(showCatPhrase, 60000);
            infoInterval = setInterval(updateInfoCards, 60000);
        }

        function stopAppIntervals() {
            clearInterval(clockInterval);
            clearInterval(phraseInterval);
            clearInterval(infoInterval);
        }

        function initializeAppView() {
            setupDaySelector();
            renderCourseLegend();
            updateInfoCards();
            // Automatically select current day or Monday
            const today = new Date().getDay(); // Sunday = 0, Monday = 1
            const dayToSelect = (today > 0 && today <= 6) ? days[today - 1] : 'Mon';
            const dayButton = Array.from(document.querySelectorAll('#day-selector button')).find(b => b.textContent === dayToSelect);
            if(dayButton) dayButton.click();
        }

        // --- Builder Logic ---
        let tempSchedule = [];
        let tempCourses = {};
        let editingClass = null;

        function showBuilderScreen(aiData = []) {
            document.getElementById('initial-import-view').classList.add('hidden');
            document.getElementById('review-view').classList.remove('hidden');
            
            tempSchedule = JSON.parse(JSON.stringify(aiData)); // Deep copy
            tempCourses = {};

            // Auto-populate courses from AI data
            tempSchedule.forEach(cls => {
                if (cls.courseName && !tempCourses[cls.courseName]) {
                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    tempCourses[cls.courseName] = { border: randomColor, bg: randomColor + '20' };
                }
            });

            renderCourseEditor();
            renderDayTabs();
            renderDayContent('Mon');
        }

        function renderCourseEditor() {
            const courseListEditor = document.getElementById('course-list-editor');
            courseListEditor.innerHTML = '';
            for (const courseName in tempCourses) {
                const courseDiv = document.createElement('div');
                courseDiv.className = 'flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-800 rounded-md';
                courseDiv.innerHTML = `
                    <input type="color" value="${tempCourses[courseName].border}" data-course-name="${courseName}" class="course-color-picker p-0 h-6 w-6 block bg-white border border-gray-200 cursor-pointer rounded-md disabled:opacity-50 disabled:pointer-events-none">
                    <span class="flex-grow">${courseName}</span>
                    <button data-course-name="${courseName}" class="delete-course-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                `;
                courseListEditor.appendChild(courseDiv);
            }
        }

        function renderDayTabs() {
            const scheduleDayTabs = document.getElementById('schedule-day-tabs');
            scheduleDayTabs.innerHTML = '';
            days.forEach(day => {
                const button = document.createElement('button');
                button.className = 'day-tab-btn py-2 px-4 font-semibold';
                button.textContent = day;
                if (day === 'Mon') button.classList.add('active');
                button.addEventListener('click', () => {
                    document.querySelectorAll('.day-tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderDayContent(day);
                });
                scheduleDayTabs.appendChild(button);
            });
        }

        function renderDayContent(day) {
            const scheduleDayContent = document.getElementById('schedule-day-content');
            scheduleDayContent.innerHTML = '';
            const classesForDay = tempSchedule.filter(c => c.day === day).sort((a,b) => (a.startTime || "").localeCompare(b.startTime || ""));
            
            if (classesForDay.length > 0) {
                classesForDay.forEach(cls => {
                    const classDiv = document.createElement('div');
                    classDiv.className = 'flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700';
                    classDiv.innerHTML = `
                        <div>
                            <p class="font-bold">${cls.courseName}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${cls.instructor || 'N/A'} @ ${cls.location || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${formatTimeStr12hr(cls.startTime)} - ${formatTimeStr12hr(cls.endTime)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-class='${JSON.stringify(cls)}' class="edit-class-btn text-blue-500 hover:text-blue-700">Edit</button>
                            <button data-class='${JSON.stringify(cls)}' class="delete-class-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                        </div>
                    `;
                    scheduleDayContent.appendChild(classDiv);
                });
            } else {
                 scheduleDayContent.innerHTML = `<p class="text-center text-gray-500 py-4">No classes for ${day}.</p>`;
            }

            const addClassBtn = document.createElement('button');
            addClassBtn.textContent = '+ Add Class to ' + day;
            addClassBtn.className = 'mt-4 w-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-semibold py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition';
            addClassBtn.addEventListener('click', () => showAddClassModal(day));
            scheduleDayContent.appendChild(addClassBtn);
        }

        function showAddClassModal(day, cls = null) {
            const courseSelect = document.getElementById('class-course-select');
            const addClassError = document.getElementById('add-class-error');
            addClassError.textContent = '';
            courseSelect.innerHTML = '';

            if(Object.keys(tempCourses).length === 0){
                courseSelect.innerHTML = '<option disabled selected>Please add a course first</option>';
            } else {
                for(const name in tempCourses) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    courseSelect.appendChild(option);
                }
            }

            document.getElementById('class-start-time').value = cls ? cls.startTime : '';
            document.getElementById('class-end-time').value = cls ? cls.endTime : '';
            document.getElementById('class-instructor').value = cls ? cls.instructor : '';
            document.getElementById('class-location').value = cls ? cls.location : '';
            document.getElementById('class-type-select').value = cls ? cls.type : 'Theory';
            if (cls) courseSelect.value = cls.courseName;

            document.getElementById('save-class-btn').dataset.day = day;
            
            const addClassModal = document.getElementById('add-class-modal');
            addClassModal.classList.remove('hidden');
            setTimeout(() => { document.getElementById('add-class-modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
        }

        function closeAddClassModal() {
            document.getElementById('add-class-modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { document.getElementById('add-class-modal').classList.add('hidden'); }, 200);
            editingClass = null;
        }

        // --- CORRECTED: AI-based Bookmarklet and Data Import Logic ---
        
        // This map contains the logic to convert VTOP slot names into days and times.
        const slotTimeMap = {
             // Theory Slots
            'A1': { day: 'Mon', startTime: '08:00', endTime: '08:50' }, 'F1': { day: 'Mon', startTime: '09:00', endTime: '09:50' },
            'D1': { day: 'Mon', startTime: '10:00', endTime: '10:50' }, 'TB1': { day: 'Mon', startTime: '11:00', endTime: '11:50' },
            'TG1': { day: 'Mon', startTime: '12:00', endTime: '12:50' }, 'A2': { day: 'Mon', startTime: '14:00', endTime: '14:50' },
            'F2': { day: 'Mon', startTime: '15:00', endTime: '15:50' }, 'D2': { day: 'Mon', startTime: '16:00', endTime: '16:50' },
            'TB2': { day: 'Mon', startTime: '17:00', endTime: '17:50' }, 'TG2': { day: 'Mon', startTime: '18:00', endTime: '18:50' },
            'B1': { day: 'Tue', startTime: '09:00', endTime: '09:50' }, 'G1': { day: 'Tue', startTime: '10:00', endTime: '10:50' },
            'E1': { day: 'Tue', startTime: '11:00', endTime: '11:50' }, 'TC1': { day: 'Tue', startTime: '12:00', endTime: '12:50' },
            'TAA1': { day: 'Tue', startTime: '13:00', endTime: '13:50' }, 'B2': { day: 'Tue', startTime: '15:00', endTime: '15:50' },
            'G2': { day: 'Tue', startTime: '16:00', endTime: '16:50' }, 'E2': { day: 'Tue', startTime: '17:00', endTime: '17:50' },
            'TC2': { day: 'Tue', startTime: '18:00', endTime: '18:50' }, 'TAA2': { day: 'Tue', startTime: '18:00', endTime: '18:50' },
            'C1': { day: 'Wed', startTime: '10:00', endTime: '10:50' }, 'A1_W': { day: 'Wed', startTime: '08:00', endTime: '08:50' },
            'F1_W': { day: 'Wed', startTime: '09:00', endTime: '09:50' }, 'V1': { day: 'Wed', startTime: '13:00', endTime: '13:50' },
            'C2': { day: 'Wed', startTime: '16:00', endTime: '16:50' }, 'E2_W': { day: 'Wed', startTime: '17:00', endTime: '17:50' },
            'TD2': { day: 'Wed', startTime: '18:00', endTime: '18:50' }, 'TBB2': { day: 'Wed', startTime: '19:00', endTime: '19:50' },
            'D1_T': { day: 'Thu', startTime: '10:00', endTime: '10:50' }, 'B1_T': { day: 'Thu', startTime: '09:00', endTime: '09:50' },
            'G1_T': { day: 'Thu', startTime: '10:00', endTime: '10:50' }, 'V2': { day: 'Thu', startTime: '13:00', endTime: '13:50' },
            'D2_T': { day: 'Thu', startTime: '16:00', endTime: '16:50' }, 'B2_T': { day: 'Thu', startTime: '15:00', endTime: '15:50' },
            'G2_T': { day: 'Thu', startTime: '16:00', endTime: '16:50' }, 'TE2': { day: 'Thu', startTime: '17:00', endTime: '17:50' },
            'TCC2': { day: 'Thu', startTime: '18:00', endTime: '18:50' }, 'TDD2': { day: 'Thu', startTime: '19:00', endTime: '19:50' },
            'E1_F': { day: 'Fri', startTime: '11:00', endTime: '11:50' }, 'C1_F': { day: 'Fri', startTime: '10:00', endTime: '10:50' },
            'V3': { day: 'Fri', startTime: '13:00', endTime: '13:50' }, 'E2_F': { day: 'Fri', startTime: '17:00', endTime: '17:50' },
            'C2_F': { day: 'Fri', startTime: '16:00', endTime: '16:50' }, 'TF2': { day: 'Fri', startTime: '18:00', endTime: '18:50' },
            'TFF2': { day: 'Fri', startTime: '19:00', endTime: '19:50' },

             // Lab Slots
            'L1+L2': { day: 'Mon', startTime: '08:00', endTime: '09:40' }, 'L3+L4': { day: 'Mon', startTime: '10:00', endTime: '11:40' },
            'L5+L6': { day: 'Mon', startTime: '12:00', endTime: '13:40' }, 'L31+L32': { day: 'Mon', startTime: '14:00', endTime: '15:40' },
            'L33+L34': { day: 'Mon', startTime: '16:00', endTime: '17:40' }, 'L35+L36': { day: 'Mon', startTime: '18:00', endTime: '19:40' },
            'L7+L8': { day: 'Tue', startTime: '08:00', endTime: '09:40' }, 'L9+L10': { day: 'Tue', startTime: '10:00', endTime: '11:40' },
            'L11+L12': { day: 'Tue', startTime: '12:00', endTime: '13:40' }, 'L37+L38': { day: 'Tue', startTime: '14:00', endTime: '15:40' },
            'L39+L40': { day: 'Tue', startTime: '16:00', endTime: '17:40' }, 'L41+L42': { day: 'Tue', startTime: '18:00', endTime: '19:40' },
            'L13+L14': { day: 'Wed', startTime: '08:00', endTime: '09:40' }, 'L15+L16': { day: 'Wed', startTime: '10:00', endTime: '11:40' },
            'L17+L18': { day: 'Wed', startTime: '12:00', endTime: '13:40' }, 'L43+L44': { day: 'Wed', startTime: '14:00', endTime: '15:40' },
            'L45+L46': { day: 'Wed', startTime: '16:00', endTime: '17:40' }, 'L47+L48': { day: 'Wed', startTime: '18:00', endTime: '19:40' },
            'L19+L20': { day: 'Thu', startTime: '08:00', endTime: '09:40' }, 'L21+L22': { day: 'Thu', startTime: '10:00', endTime: '11:40' },
            'L23+L24': { day: 'Thu', startTime: '12:00', endTime: '13:40' }, 'L49+L50': { day: 'Thu', startTime: '14:00', endTime: '15:40' },
            'L51+L52': { day: 'Thu', startTime: '16:00', endTime: '17:40' }, 'L53+L54': { day: 'Thu', startTime: '18:00', endTime: '19:40' },
            'L25+L26': { day: 'Fri', startTime: '08:00', endTime: '09:40' }, 'L27+L28': { day: 'Fri', startTime: '10:00', endTime: '11:40' },
            'L29+L30': { day: 'Fri', startTime: '12:00', endTime: '13:40' }, 'L55+L56': { day: 'Fri', startTime: '14:00', endTime: '15:40' },
            'L57+L58': { day: 'Fri', startTime: '16:00', endTime: '17:40' }, 'L59+L60': { day: 'Fri', startTime: '18:00', endTime: '19:40' },
        };

        function setupBookmarkletLink() {
            const bookmarkletCode = `
                (function() {
                    alert('Copying timetable page HTML for AI analysis...');
                    const container = document.getElementById('page-wrapper') || document.getElementById('b3wrapper') || document.body;
                    const htmlContent = container.innerHTML;
                    if (!htmlContent || htmlContent.length < 500) {
                        alert('Error: Could not find sufficient page content to copy. Please navigate to your timetable page and try again.');
                        return;
                    }
                    try {
                        const data = btoa(unescape(encodeURIComponent(htmlContent)));
                        const appUrl = '${window.location.origin}${window.location.pathname}';
                        localStorage.setItem('vtopTimetableHTML', data);
                        alert('HTML copied! Redirecting you to the timetable app for AI parsing...');
                        window.location.href = appUrl;
                    } catch(e) {
                        alert('An error occurred while encoding the page data: ' + e.message);
                    }
                })();
            `;
            
            const minifiedCode = bookmarkletCode.replace(/\s{2,}/g, ' ').trim();
            const bookmarkletLink = document.getElementById('bookmarklet-link');
            if(bookmarkletLink) {
                 bookmarkletLink.href = `javascript:${minifiedCode}`;
            }
        }
        
        // This function processes the raw data from the AI
        function processAIReponse(rawData) {
            let finalSchedule = [];
            rawData.forEach(item => {
                const parts = item.slotVenue.split('-');
                const slotCode = parts[0].trim();
                const venue = parts.slice(1).join('-').trim();

                // Check for combined lab slots first
                if (slotTimeMap[slotCode]) {
                     const timeInfo = slotTimeMap[slotCode];
                     finalSchedule.push({
                         courseName: item.courseName,
                         type: (item.type.toLowerCase().includes('lab')) ? 'Lab' : 'Theory',
                         instructor: item.instructor,
                         day: timeInfo.day,
                         startTime: timeInfo.startTime,
                         endTime: timeInfo.endTime,
                         location: venue
                     });
                } else {
                    // Handle individual theory slots that might be combined with '+'
                    const individualSlots = slotCode.split('+');
                    individualSlots.forEach(slot => {
                        if (slotTimeMap[slot]) {
                            const timeInfo = slotTimeMap[slot];
                            finalSchedule.push({
                                courseName: item.courseName,
                                type: (item.type.toLowerCase().includes('lab')) ? 'Lab' : 'Theory',
                                instructor: item.instructor,
                                day: timeInfo.day,
                                startTime: timeInfo.startTime,
                                endTime: timeInfo.endTime,
                                location: venue
                            });
                        }
                    });
                }
            });
            return finalSchedule;
        }

        async function parseTimetableWithAI(html) {
            const loadingContainer = document.getElementById('loading-container');
            const importError = document.getElementById('import-error');
            if (!loadingContainer || !importError) return;

            if (!geminiApiKey || geminiApiKey === "PASTE_YOUR_NEW_API_KEY_HERE") {
                importError.textContent = "Error: Please provide a valid Gemini API Key in the application script to enable AI import.";
                return;
            }

            loadingContainer.classList.remove('hidden');
            importError.textContent = "";

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            
            const prompt = `You are a utility that ONLY extracts information from HTML. From the provided HTML of a VTOP university timetable page, find the main table of registered courses. For each row in that table, extract the following information: - "courseName": The text from the "Course" column. - "type": The text from the "Class Group" column (e.g., "Embedded Theory"). - "instructor": The text from the "Faculty Details" column. - "slotVenue": The raw text from the "Slot-Venue" column (e.g., "F1+TF1-SENSE"). Return this information as a single, minified, valid JSON array. Your entire response MUST be only the JSON array and nothing else. Do not include any text, explanations, or markdown formatting like \\\`\\\`\\\`json. HTML to parse: ${html}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
                      throw new Error("Invalid response structure from AI API.");
                }

                const jsonString = result.candidates[0].content.parts[0].text.trim();
                const rawData = JSON.parse(jsonString);
                
                const processedData = processAIReponse(rawData);

                if (processedData.length === 0) {
                    throw new Error("The AI extracted data, but it could not be mapped to timetable slots. The slot format might have changed.");
                }

                showBuilderScreen(processedData);

            } catch (error) {
                console.error("AI parsing failed:", error);
                importError.textContent = `AI processing failed. ${error.message} Please try the manual builder.`;
            } finally {
                loadingContainer.classList.add('hidden');
            }
        }

        // --- DOMContentLoaded: Main entry point ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Get all elements ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const importContainer = document.getElementById('import-container');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const deleteTimetableBtn = document.getElementById('delete-timetable-btn');
            const initialImportView = document.getElementById('initial-import-view');
            const reviewView = document.getElementById('review-view');
            const launchBuilderBtn = document.getElementById('launch-builder-btn');
            const confirmSaveBtnBuilder = document.getElementById('confirm-save-btn');
            const cancelBuildBtn = document.getElementById('cancel-build-btn');
            const addCourseBtn = document.getElementById('add-course-btn');
            const courseListEditor = document.getElementById('course-list-editor');
            const scheduleDayContent = document.getElementById('schedule-day-content');
            const newCourseNameInput = document.getElementById('new-course-name');
            const newCourseColorInput = document.getElementById('new-course-color');
            const importTabs = document.getElementById('import-tabs');
            const classModal = document.getElementById('class-modal');
            const betaModal = document.getElementById('beta-modal');
            const deleteModal = document.getElementById('delete-modal');
            const addClassModal = document.getElementById('add-class-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            let isImportFlow = false;

            // --- Check for imported data from localStorage FIRST ---
            const importedHtmlData = localStorage.getItem('vtopTimetableHTML');
            if (importedHtmlData) {
                isImportFlow = true;
                localStorage.removeItem('vtopTimetableHTML');
                
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                importContainer.classList.remove('hidden');
                
                try {
                    const decodedHtml = decodeURIComponent(atob(importedHtmlData));
                    document.getElementById('import-tabs').classList.add('hidden');
                    parseTimetableWithAI(decodedHtml);
                } catch (e) {
                    console.error("Failed to parse imported HTML data:", e);
                    document.getElementById('import-error').textContent = "There was an error decoding the timetable data.";
                }
            }
            
            // --- Set up auth listener ---
            onAuthStateChanged(auth, user => {
                if (isImportFlow) {
                    return; // Do nothing if we are in the middle of an import
                }
                if (user) {
                    listenToTimetable(user.uid);
                } else {
                    if (unsubscribe) unsubscribe();
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    importContainer.classList.add('hidden');
                    stopAppIntervals();
                    setupBookmarkletLink();
                }
            });
            
            // --- Add all other event listeners ---
            setupThemeSwitcher();
            setupBookmarkletLink();

            document.getElementById('beta-button').addEventListener('click', showBetaModal);
            
            classModal.addEventListener('click', (e) => { if (e.target === classModal) closeClassModal(); });
            betaModal.addEventListener('click', (e) => { if (e.target === betaModal) closeBetaModal(); });
            deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });
            addClassModal.addEventListener('click', (e) => { if (e.target === addClassModal) closeAddClassModal(); });
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            document.getElementById('cancel-add-class-btn').addEventListener('click', closeAddClassModal);

            googleLoginBtn.addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                const authError = document.getElementById('auth-error');
                signInWithPopup(auth, provider)
                    .catch((error) => {
                        console.error("Google sign-in error", error);
                        authError.textContent = "Could not sign in. Please try again. " + error.code;
                    });
            });

            logoutBtn.addEventListener('click', () => signOut(auth));
            deleteTimetableBtn.addEventListener('click', showDeleteModal);
            
            confirmDeleteBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                const timetableRef = doc(db, "timetables", user.uid);
                try {
                    await deleteDoc(timetableRef);
                    closeDeleteModal();
                } catch (error) {
                    console.error("Error deleting timetable: ", error);
                    closeDeleteModal();
                }
            });

            importTabs.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') return;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab-content-${e.target.dataset.tab}`).classList.remove('hidden');
            });

            launchBuilderBtn.addEventListener('click', () => {
                isImportFlow = true; // Enter import mode for manual build too
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                importContainer.classList.remove('hidden');
                showBuilderScreen([]);
            });
            
            cancelBuildBtn.addEventListener('click', () => {
                window.location.reload();
            });

            addCourseBtn.addEventListener('click', () => {
                const name = newCourseNameInput.value.trim();
                if (name && !tempCourses[name]) {
                    const color = newCourseColorInput.value;
                    tempCourses[name] = { border: color, bg: color + '20' };
                    newCourseNameInput.value = '';
                    renderCourseEditor();
                }
            });

            courseListEditor.addEventListener('click', e => {
                if (e.target.classList.contains('delete-course-btn')) {
                    const courseName = e.target.dataset.courseName;
                    delete tempCourses[courseName];
                    tempSchedule = tempSchedule.filter(cls => cls.courseName !== courseName);
                    renderCourseEditor();
                    const activeTab = document.querySelector('.day-tab-btn.active');
                    if (activeTab) {
                        renderDayContent(activeTab.textContent);
                    }
                }
                if (e.target.classList.contains('course-color-picker')) {
                    e.target.addEventListener('input', (event) => {
                        const courseName = event.target.dataset.courseName;
                        const newColor = event.target.value;
                        if (tempCourses[courseName]) {
                            tempCourses[courseName].border = newColor;
                            tempCourses[courseName].bg = newColor + '20';
                        }
                    }, { once: true });
                }
            });

            scheduleDayContent.addEventListener('click', e => {
                 const editButton = e.target.closest('.edit-class-btn');
                const deleteButton = e.target.closest('.delete-class-btn');

                if (editButton) {
                    const classData = JSON.parse(editButton.dataset.class);
                    editingClass = classData;
                    showAddClassModal(classData.day, classData);
                }
                if (deleteButton) {
                    const classData = JSON.parse(deleteButton.dataset.class);
                    tempSchedule = tempSchedule.filter(cls => JSON.stringify(cls) !== JSON.stringify(classData));
                    renderDayContent(classData.day);
                }
            });

            document.getElementById('save-class-btn').addEventListener('click', () => {
                const addClassError = document.getElementById('add-class-error');
                addClassError.textContent = '';
                const day = document.getElementById('save-class-btn').dataset.day;
                const courseName = document.getElementById('class-course-select').value;
                const startTime = document.getElementById('class-start-time').value;
                const endTime = document.getElementById('class-end-time').value;
                const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;

                if (!courseName || courseName === 'Please add a course first') {
                    addClassError.textContent = "Please select a course."; return;
                }
                if (!startTime || !endTime) {
                    addClassError.textContent = "Please enter both a start and end time."; return;
                }
                if (!timeRegex.test(startTime) || !timeRegex.test(endTime)) {
                    addClassError.textContent = "Please use the 24-hour HH:MM format for time."; return;
                }
                if (timeToMinutes(startTime) >= timeToMinutes(endTime)) {
                    addClassError.textContent = "End time must be after start time."; return;
                }
                const newClass = {
                    day: day, courseName: courseName, startTime: startTime, endTime: endTime,
                    instructor: document.getElementById('class-instructor').value,
                    location: document.getElementById('class-location').value,
                    type: document.getElementById('class-type-select').value,
                };
                if (editingClass) {
                    const index = tempSchedule.findIndex(c => JSON.stringify(c) === JSON.stringify(editingClass));
                    if (index > -1) tempSchedule[index] = newClass;
                } else {
                    tempSchedule.push(newClass);
                }
                renderDayContent(day);
                closeAddClassModal();
            });

            confirmSaveBtnBuilder.addEventListener('click', async () => {
                const performSave = async (user) => {
                    if (!user) {
                        alert("Could not get user information to save.");
                        return;
                    }
                    try {
                        const timetableRef = doc(db, "timetables", user.uid);
                        await setDoc(timetableRef, { schedule: tempSchedule, courses: tempCourses });
                        isImportFlow = false; 
                        window.location.reload(); 
                    } catch (e) {
                        console.error("Error saving schedule: ", e);
                        alert("Could not save timetable. Please try again.");
                    }
                };
                
                if (auth.currentUser) {
                    await performSave(auth.currentUser);
                } else {
                    const provider = new GoogleAuthProvider();
                    try {
                        const result = await signInWithPopup(auth, provider);
                        await performSave(result.user);
                    } catch (error) {
                        console.error("Google sign-in error during save:", error);
                        alert("You must sign in to save your timetable. " + error.code);
                    }
                }
            });
        });
    </script>
</body>
</html>
"
its showing this now when i am trying to run the code 

An error occurred

URI_TOO_LONG

btoa1::

